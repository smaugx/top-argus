<!DOCTYPE html>
<html>
    
    <head>
        <meta charset="utf-8">
        <title>
            第一个 ECharts 实例
        </title>
        <!-- 引入 echarts.js -->
        <script src="https://cdn.staticfile.org/echarts/4.3.0/echarts.min.js">
        </script>
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js">
        </script>
        <script type="text/javascript" src="http://cdn.highcharts.com.cn/highcharts/highcharts.js">
        </script>
    </head>
    
    <body>
        <!-- 为ECharts准备一个具备大小（宽高）的Dom -->
        <div id="main" style="width: 900px;height:500px;">
        </div>
        <div id="main2" style="width: 900px;height:500px;">
        </div>
        <div id="container" style="min-width:400px;height:400px">
        </div>
        <script type="text/javascript">
            function update_drop_rate() {
                $.ajax({
                    cache: false,
                    type: "GET",
                    url: "/api/web/packet_drop?begin=1575295008608&end=1575295128183",
                    data: null,
                    dataType: "json",
                    async: false,
                    error: function(request) {
                        alert("发送请求失败！");
                    },
                    success: function(response) {

                        results = response['results']
                        var data = results

                        var hchart = Highcharts.chart('container', {
                            chart: {
                                zoomType: 'x'
                            },
                            title: {
                                text: '全网丢包率走势图'
                            },
                            subtitle: {
                                text: document.ontouchstart === undefined ? '鼠标拖动可以进行缩放': '手势操作进行缩放'
                            },
                            xAxis: {
                                type: 'datetime',
                                dateTimeLabelFormats: {
                                    millisecond: '%H:%M:%S.%L',
                                    second: '%H:%M:%S',
                                    minute: '%H:%M',
                                    hour: '%H:%M',
                                    day: '%m-%d',
                                    week: '%m-%d',
                                    month: '%Y-%m',
                                    year: '%Y'
                                }
                            },
                            tooltip: {
                                dateTimeLabelFormats: {
                                    millisecond: '%H:%M:%S.%L',
                                    second: '%H:%M:%S',
                                    minute: '%H:%M',
                                    hour: '%H:%M',
                                    day: '%Y-%m-%d',
                                    week: '%m-%d',
                                    month: '%Y-%m',
                                    year: '%Y'
                                }
                            },
                            yAxis: {
                                title: {
                                    text: '丢包率(%)'
                                }
                            },
                            legend: {
                                enabled: false
                            },
                            plotOptions: {
                                area: {
                                    fillColor: {
                                        linearGradient: {
                                            x1: 0,
                                            y1: 0,
                                            x2: 0,
                                            y2: 1
                                        },
                                        stops: [[0, Highcharts.getOptions().colors[0]], [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]]
                                    },
                                    marker: {
                                        radius: 2
                                    },
                                    lineWidth: 1,
                                    states: {
                                        hover: {
                                            lineWidth: 1
                                        }
                                    },
                                    threshold: null
                                }
                            },
                            series: [{
                                type: 'area',
                                name: '平均丢包率',
                                data: data
                            }]
                        });

                    }

                });
            }

            var myChart = echarts.init(document.getElementById('main'));
            var myChart2 = echarts.init(document.getElementById('main2'));

            function get_pie(real_text, real_subtext, real_data) {
                var keys = new Array();
                for (var i = 0; i < real_data.length; i++) {
                    item = real_data[i]
                    keys.push(item['name'])
                }
                // 设置---------------------
                option = {
                    title: {
                        text: real_text,
                        subtext: real_subtext,
                        x: 'center'
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: "{a} <br/>{b} : {c} ({d}%)"
                    },
                    legend: {
                        orient: 'vertical',
                        left: 'left',
                        data: keys
                    },
                    series: [{
                        name: real_subtext,
                        type: 'pie',
                        radius: '55%',
                        center: ['50%', '60%'],
                        /*
                        data:[
                            {value:3335, name:'直接访问'},
                            {value:3110, name:'邮件营销'},
                            {value:234, name:'联盟广告'},
                            {value:135, name:'视频广告'},
                            {value:1548, name:'搜索引擎'}
                        ],
                        */

                        data: real_data,
                        itemStyle: {
                            emphasis: {
                                shadowBlur: 20,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }]
                };
                return option;

            }

            function update_virtual_network(myChart) {
                $.ajax({
                    cache: false,
                    type: "GET",
                    url: "/api/web/networkid?virtual=true",
                    data: null,
                    dataType: "json",
                    async: false,
                    error: function(request) {
                        alert("发送请求失败！");
                    },
                    success: function(response) {
                        console.log(response);
                        results = response['results']
                        network_info = results['network_info']
                        network_size = results['network_size']

                        var real_data = new Array();
                        var total_virtual_node = 0;
                        var name_filter = {
                            'Rec': 1,
                            'Zec': 1,
                            'Edg': 1,
                            'Arc': 1,
                            'Aud': 1,
                            'Val': 1,
                            'Other': 1
                        };
                        for (var i = 0; i < network_info.length; ++i) {
                            var value = network_info[i]['network_size'];
                            var name = network_info[i]['network_id'];
                            if (name.startsWith('640000')) {
                                //name = 'Rec(' + name + ")";
                                name = 'Rec' + name_filter['Rec'] + "  (" + value + ")";
                                name_filter['Rec'] += 1;
                            } else if (name.startsWith('650000')) {
                                //name = 'Zec(' + name + ")";
                                name = 'Zec' + name_filter['Zec'] + "  (" + value + ")";
                                name_filter['Zec'] += 1;
                            } else if (name.startsWith('660000')) {
                                //name = 'Edge(' + name + ")";
                                name = 'Edg' + name_filter['Edg'] + "  (" + value + ")";
                                name_filter['Edg'] += 1;
                            } else if (name.startsWith('670000')) {
                                //name = 'Archive(' + name + ")";
                                name = 'Arc' + name_filter['Arc'] + "  (" + value + ")";
                                name_filter['Arc'] += 1;
                            } else if (name.startsWith('680000')) {
                                //name = 'Auditor(' + name + ")";
                                name = 'Aud' + name_filter['Aud'] + "  (" + value + ")";
                                name_filter['Aud'] += 1;
                            } else if (name.startsWith('690000')) {
                                //name = 'Validator(' + name + ")";
                                name = 'Val' + name_filter['Val'] + "  (" + value + ")";
                                name_filter['Val'] += 1;
                            } else {
                                name = 'Other' + name_filter['Other'] + "  (" + value + ")";
                                name_filter['Other'] += 1;
                            }

                            total_virtual_node += value;
                            item = {
                                'value': value,
                                'name': name
                            };
                            real_data.push(item);
                        }

                        var vn_pie = get_pie('主网虚拟节点分布(总数:' + total_virtual_node + ")", 'betatest', real_data);
                        // 为echarts对象加载数据-------------- 
                        myChart.setOption(vn_pie);
                    }
                });
            } // end function update_virtual...
            function update_real_network(myChart) {
                $.ajax({
                    cache: false,
                    type: "GET",
                    url: "/api/web/network?network_id=010000&withip=true",
                    data: null,
                    dataType: "json",
                    async: false,
                    error: function(request) {
                        alert("发送请求失败！");
                    },
                    success: function(response) {
                        console.log(response);
                        results = response['results']
                        node_info = results['node_info']
                        node_size = results['node_size']

                        var real_data = new Array();
                        var country_map = {};
                        var total_real_node = node_size;
                        for (var i = 0; i < node_info.length; ++i) {
                            var country_name = node_info[i]['node_country']
                            var node_id = node_info[i]['node_id']
                            var node_ip = node_info[i]['node_ip']
                            if (country_map.hasOwnProperty(country_name)) {
                                country_map[country_name] += 1
                            } else {
                                country_map[country_name] = 0
                            }
                        }

                        for (var cname in country_map) {
                            var value = country_map[cname];
                            var name = cname + "  (" + value + ")";
                            item = {
                                'value': value,
                                'name': name
                            };
                            real_data.push(item);
                        }

                        var rn_pie = get_pie('主网物理节点分布(总数:' + total_real_node + ")", 'betatest', real_data);
                        // 为echarts对象加载数据-------------- 
                        myChart2.setOption(rn_pie);
                    }
                });
            } // end function update_real...
            update_virtual_network(myChart);
            update_real_network(myChart2);
            update_drop_rate();
        </script>
    </body>

</html>
